from datetime import datetime
from typing import Optional

ZODIAC_SIGNS = {
    "Овен": {
        "dates": [(3, 21), (4, 19)],
        "element": "Огонь",
        "quality": "Кардинальный",
        "traits": "Энергичный, смелый, импульсивный, лидер по натуре. Любит быть первым и не боится рисковать.",
        "careers": ["Предприниматель", "Спортсмен", "Руководитель", "Хирург", "Военный"],
        "strengths": "Храбрость, решительность, энтузиазм, уверенность, страстность",
        "challenges": "Импульсивность, нетерпеливость, агрессивность, эгоцентризм",
        "compatible": ["Лев", "Стрелец", "Близнецы", "Водолей"]
    },
    "Телец": {
        "dates": [(4, 20), (5, 20)],
        "element": "Земля",
        "quality": "Фиксированный",
        "traits": "Надежный, практичный, упрямый, ценит стабильность и комфорт. Материалист с хорошим вкусом.",
        "careers": ["Финансист", "Шеф-повар", "Дизайнер", "Архитектор", "Банкир"],
        "strengths": "Надежность, терпение, практичность, преданность, ответственность",
        "challenges": "Упрямство, собственничество, медлительность, материализм",
        "compatible": ["Дева", "Козерог", "Рак", "Рыбы"]
    },
    "Близнецы": {
        "dates": [(5, 21), (6, 20)],
        "element": "Воздух",
        "quality": "Мутабельный",
        "traits": "Общительный, любознательный, адаптивный. Быстро обучается, любит общение и разнообразие.",
        "careers": ["Журналист", "Писатель", "Преподаватель", "Маркетолог", "Переводчик"],
        "strengths": "Коммуникабельность, остроумие, адаптивность, любознательность",
        "challenges": "Непостоянство, поверхностность, нервозность, нерешительность",
        "compatible": ["Весы", "Водолей", "Овен", "Лев"]
    },
    "Рак": {
        "dates": [(6, 21), (7, 22)],
        "element": "Вода",
        "quality": "Кардинальный",
        "traits": "Эмоциональный, заботливый, интуитивный. Глубоко чувствует, ценит дом и семью.",
        "careers": ["Психолог", "Медсестра", "Повар", "Учитель", "Риелтор"],
        "strengths": "Эмпатия, преданность, интуиция, заботливость, защита близких",
        "challenges": "Обидчивость, капризность, излишняя эмоциональность, зависимость",
        "compatible": ["Скорпион", "Рыбы", "Телец", "Дева"]
    },
    "Лев": {
        "dates": [(7, 23), (8, 22)],
        "element": "Огонь",
        "quality": "Фиксированный",
        "traits": "Уверенный, харизматичный, щедрый. Прирожденный лидер, любит быть в центре внимания.",
        "careers": ["Актер", "Руководитель", "Режиссер", "Политик", "Предприниматель"],
        "strengths": "Харизма, щедрость, креативность, уверенность, лидерство",
        "challenges": "Высокомерие, доминирование, эгоцентризм, упрямство",
        "compatible": ["Овен", "Стрелец", "Близнецы", "Весы"]
    },
    "Дева": {
        "dates": [(8, 23), (9, 22)],
        "element": "Земля",
        "quality": "Мутабельный",
        "traits": "Аналитичный, перфекционист, практичный. Внимателен к деталям, служит другим.",
        "careers": ["Аналитик", "Врач", "Бухгалтер", "Редактор", "Диетолог"],
        "strengths": "Аналитичность, трудолюбие, практичность, надежность, внимание к деталям",
        "challenges": "Критичность, перфекционизм, беспокойство, застенчивость",
        "compatible": ["Телец", "Козерог", "Рак", "Скорпион"]
    },
    "Весы": {
        "dates": [(9, 23), (10, 22)],
        "element": "Воздух",
        "quality": "Кардинальный",
        "traits": "Дипломатичный, справедливый, общительный. Стремится к гармонии и балансу во всем.",
        "careers": ["Юрист", "Дипломат", "Дизайнер", "Консультант", "Медиатор"],
        "strengths": "Дипломатичность, справедливость, обаяние, социальность, эстетизм",
        "challenges": "Нерешительность, избегание конфликтов, зависимость от одобрения",
        "compatible": ["Близнецы", "Водолей", "Лев", "Стрелец"]
    },
    "Скорпион": {
        "dates": [(10, 23), (11, 21)],
        "element": "Вода",
        "quality": "Фиксированный",
        "traits": "Страстный, интенсивный, проницательный. Глубокий, магнетический, трансформирующий.",
        "careers": ["Психолог", "Детектив", "Хирург", "Исследователь", "Финансист"],
        "strengths": "Страстность, решительность, проницательность, преданность, храбрость",
        "challenges": "Ревность, мстительность, скрытность, манипулятивность",
        "compatible": ["Рак", "Рыбы", "Дева", "Козерог"]
    },
    "Стрелец": {
        "dates": [(11, 22), (12, 21)],
        "element": "Огонь",
        "quality": "Мутабельный",
        "traits": "Оптимистичный, авантюрный, философский. Любит путешествия, свободу и познание.",
        "careers": ["Путешественник", "Преподаватель", "Писатель", "Спортсмен", "Философ"],
        "strengths": "Оптимизм, щедрость, идеализм, чувство юмора, честность",
        "challenges": "Нетактичность, безответственность, излишний оптимизм, непостоянство",
        "compatible": ["Овен", "Лев", "Весы", "Водолей"]
    },
    "Козерог": {
        "dates": [(12, 22), (1, 19)],
        "element": "Земля",
        "quality": "Кардинальный",
        "traits": "Амбициозный, дисциплинированный, ответственный. Целеустремленный и практичный.",
        "careers": ["Менеджер", "Архитектор", "Администратор", "Инженер", "Политик"],
        "strengths": "Дисциплина, ответственность, амбициозность, терпение, мудрость",
        "challenges": "Пессимизм, жесткость, скупость, склонность к депрессии",
        "compatible": ["Телец", "Дева", "Скорпион", "Рыбы"]
    },
    "Водолей": {
        "dates": [(1, 20), (2, 18)],
        "element": "Воздух",
        "quality": "Фиксированный",
        "traits": "Независимый, прогрессивный, гуманитарный. Оригинальный мыслитель и реформатор.",
        "careers": ["Изобретатель", "Программист", "Ученый", "Активист", "Астролог"],
        "strengths": "Оригинальность, прогрессивность, гуманность, интеллект, независимость",
        "challenges": "Отстраненность, упрямство, непредсказуемость, холодность",
        "compatible": ["Близнецы", "Весы", "Овен", "Стрелец"]
    },
    "Рыбы": {
        "dates": [(2, 19), (3, 20)],
        "element": "Вода",
        "quality": "Мутабельный",
        "traits": "Интуитивный, сострадательный, артистичный. Мечтательный и духовно развитый.",
        "careers": ["Художник", "Музыкант", "Психолог", "Целитель", "Актер"],
        "strengths": "Сострадание, интуиция, артистизм, мудрость, адаптивность",
        "challenges": "Излишняя эмоциональность, эскапизм, жертвенность, нерешительность",
        "compatible": ["Рак", "Скорпион", "Телец", "Козерог"]
    }
}

CHINESE_ZODIAC = {
    "Крыса": {"years": [1936, 1948, 1960, 1972, 1984, 1996, 2008, 2020], "traits": "Умный, находчивый, харизматичный"},
    "Бык": {"years": [1937, 1949, 1961, 1973, 1985, 1997, 2009, 2021], "traits": "Трудолюбивый, надежный, терпеливый"},
    "Тигр": {"years": [1938, 1950, 1962, 1974, 1986, 1998, 2010, 2022], "traits": "Смелый, уверенный, конкурентный"},
    "Кролик": {"years": [1939, 1951, 1963, 1975, 1987, 1999, 2011, 2023], "traits": "Нежный, спокойный, элегантный"},
    "Дракон": {"years": [1940, 1952, 1964, 1976, 1988, 2000, 2012, 2024], "traits": "Уверенный, интеллектуальный, энтузиаст"},
    "Змея": {"years": [1941, 1953, 1965, 1977, 1989, 2001, 2013, 2025], "traits": "Мудрый, интуитивный, загадочный"},
    "Лошадь": {"years": [1942, 1954, 1966, 1978, 1990, 2002, 2014, 2026], "traits": "Энергичный, независимый, свободолюбивый"},
    "Коза": {"years": [1943, 1955, 1967, 1979, 1991, 2003, 2015, 2027], "traits": "Спокойный, мягкий, сострадательный"},
    "Обезьяна": {"years": [1944, 1956, 1968, 1980, 1992, 2004, 2016, 2028], "traits": "Остроумный, любопытный, изобретательный"},
    "Петух": {"years": [1945, 1957, 1969, 1981, 1993, 2005, 2017, 2029], "traits": "Наблюдательный, трудолюбивый, смелый"},
    "Собака": {"years": [1946, 1958, 1970, 1982, 1994, 2006, 2018, 2030], "traits": "Верный, честный, ответственный"},
    "Свинья": {"years": [1947, 1959, 1971, 1983, 1995, 2007, 2019, 2031], "traits": "Сострадательный, щедрый, старательный"}
}


def get_zodiac_sign(birth_date: datetime) -> str:
    month = birth_date.month
    day = birth_date.day
    
    for sign, data in ZODIAC_SIGNS.items():
        start_month, start_day = data["dates"][0]
        end_month, end_day = data["dates"][1]
        
        if (month == start_month and day >= start_day) or (month == end_month and day <= end_day):
            return sign
    
    return "Козерог"


def get_chinese_zodiac(year: int) -> str:
    for animal, data in CHINESE_ZODIAC.items():
        if year in data["years"]:
            return animal
    
    base_year = 1936
    animals = list(CHINESE_ZODIAC.keys())
    index = (year - base_year) % 12
    return animals[index]


def calculate_life_path_number(birth_date: datetime) -> int:
    date_string = birth_date.strftime("%d%m%Y")
    total = sum(int(digit) for digit in date_string)
    
    while total > 9 and total not in [11, 22, 33]:
        total = sum(int(digit) for digit in str(total))
    
    return total


def calculate_soul_number(name: str) -> Optional[int]:
    if not name:
        return None
    
    vowels = "аеёиоуыэюяАЕЁИОУЫЭЮЯaeiouyAEIOUY"
    letter_values = {
        'а': 1, 'б': 2, 'в': 3, 'г': 4, 'д': 5, 'е': 6, 'ё': 7, 'ж': 8, 'з': 9,
        'и': 1, 'й': 1, 'к': 2, 'л': 3, 'м': 4, 'н': 5, 'о': 7, 'п': 8, 'р': 9,
        'с': 1, 'т': 2, 'у': 3, 'ф': 4, 'х': 5, 'ц': 6, 'ч': 7, 'ш': 8, 'щ': 9,
        'ъ': 1, 'ы': 1, 'ь': 1, 'э': 6, 'ю': 7, 'я': 8,
        'a': 1, 'b': 2, 'c': 3, 'd': 4, 'e': 5, 'f': 6, 'g': 7, 'h': 8, 'i': 9,
        'j': 1, 'k': 2, 'l': 3, 'm': 4, 'n': 5, 'o': 6, 'p': 7, 'q': 8, 'r': 9,
        's': 1, 't': 2, 'u': 3, 'v': 4, 'w': 5, 'x': 6, 'y': 7, 'z': 8
    }
    
    total = 0
    for char in name.lower():
        if char in vowels and char.lower() in letter_values:
            total += letter_values[char.lower()]
    
    while total > 9 and total not in [11, 22, 33]:
        total = sum(int(digit) for digit in str(total))
    
    return total if total > 0 else None


def get_life_path_description(number: int) -> str:
    descriptions = {
        1: "Лидер и первопроходец. Независимость, амбиции, инновации.",
        2: "Миротворец и дипломат. Сотрудничество, баланс, чувствительность.",
        3: "Творец и коммуникатор. Креативность, самовыражение, радость.",
        4: "Строитель и организатор. Стабильность, практичность, трудолюбие.",
        5: "Искатель приключений. Свобода, перемены, адаптивность.",
        6: "Заботливый и ответственный. Семья, служение, гармония.",
        7: "Мыслитель и аналитик. Духовность, интуиция, поиск истины.",
        8: "Достигатель успеха. Власть, материальный успех, авторитет.",
        9: "Гуманитарий и идеалист. Сострадание, мудрость, завершение циклов.",
        11: "Мастер-число. Духовный учитель, интуиция, вдохновение.",
        22: "Мастер-строитель. Воплощение больших идей, масштабное влияние.",
        33: "Мастер-целитель. Безусловная любовь, духовное учительство."
    }
    return descriptions.get(number, "Уникальный путь развития")


def create_astro_profile(birth_date_str: str, birth_time: Optional[str] = None,
                        birth_city: Optional[str] = None, birth_country: Optional[str] = None) -> dict:
    try:
        birth_date = datetime.strptime(birth_date_str, "%Y-%m-%d")
    except ValueError:
        raise ValueError("Неверный формат даты. Используйте YYYY-MM-DD")
    
    zodiac = get_zodiac_sign(birth_date)
    zodiac_data = ZODIAC_SIGNS[zodiac]
    chinese = get_chinese_zodiac(birth_date.year)
    life_path = calculate_life_path_number(birth_date)
    
    return {
        "birth_date": birth_date_str,
        "birth_time": birth_time,
        "birth_city": birth_city,
        "birth_country": birth_country,
        "zodiac_sign": zodiac,
        "zodiac_element": zodiac_data["element"],
        "zodiac_quality": zodiac_data["quality"],
        "chinese_zodiac": chinese,
        "life_path_number": life_path,
        "soul_number": None,
        "personality_traits": zodiac_data["traits"],
        "career_recommendations": ", ".join(zodiac_data["careers"]),
        "strengths": zodiac_data["strengths"],
        "challenges": zodiac_data["challenges"],
        "compatibility_signs": zodiac_data["compatible"]
    }

